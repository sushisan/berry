<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8. Características avanzadas &mdash; berry 1.1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. FFI" href="Capitulo-9.html" />
    <link rel="prev" title="7. Bibliotecas y Módulos" href="Capitulo-7.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> berry
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../en/Home.html">English</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="Home.html">Spanish</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="Referencia.html">Manual de referencia del lenguaje Berry Script</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="Referencia.html#prefacio">Prefacio</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="Capitulo-1.html">Capítulo 1 - Información básica</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-2.html">Capítulo 2 - Tipos y variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-3.html">Capítulo 3 - Expresión</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-4.html">Capítulo 4 - Declaración</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-5.html">Capítulo 5 - Función</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-6.html">Capítulo 6 - Función orientada a objetos</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-7.html">Capítulo 7 - Bibliotecas y módulos</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Capítulo 8 - Funciones avanzadas</a></li>
<li class="toctree-l4"><a class="reference internal" href="Capitulo-9.html">Capítulo 9 - Interfaz interactiva del lenguaje</a></li>
<li class="toctree-l4"><a class="reference internal" href="Apendice-A.html">Apéndice A - Definición de gramática</a></li>
<li class="toctree-l4"><a class="reference internal" href="Apendice-B.html">Apéndice B - Intérprete del compilador</a></li>
<li class="toctree-l4"><a class="reference internal" href="Apendice-C.html">Apéndice C - Guía de Portabilidad</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="FFI-Ejemplo.html">Hacer una función nativa</a></li>
<li class="toctree-l2"><a class="reference internal" href="FFI-Ejemplo.html#crear-una-instancia-de-un-objeto-list-en-una-funcion-nativa">Crear una instancia de un objeto <code class="docutils literal notranslate"><span class="pre">list</span></code> en una función nativa</a></li>
<li class="toctree-l2"><a class="reference internal" href="Hoja-de-ruta.html">Hoja de ruta</a></li>
<li class="toctree-l2"><a class="reference internal" href="Requerimientos-de-Memoria.html">Requerimientos de Memoria</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Berry API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">berry</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="Home.html">Bienvenido a la wiki de Berry!</a> &raquo;</li>
          <li><a href="Referencia.html">Manual de referencia del lenguaje Berry Script</a> &raquo;</li>
      <li>8. Características avanzadas</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/es/Capitulo-8.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <!-- Spanish Translation: Emiliano Gonzalez (egonzalez . hiperion @ gmail . com) --><section id="caracteristicas-avanzadas">
<h1>8. Características avanzadas<a class="headerlink" href="#caracteristicas-avanzadas" title="Permalink to this headline">¶</a></h1>
<section id="modo-estricto">
<h2>8.1 Modo <code class="docutils literal notranslate"><span class="pre">estricto</span></code><a class="headerlink" href="#modo-estricto" title="Permalink to this headline">¶</a></h2>
<p>Berry permite total libertad del desarrollador. Pero después de un poco
de experiencia en la codificación con Berry, encontrará que hay errores
comunes que son difíciles de encontrar y que el compilador podría
ayudarlo a detectar. El modo <code class="docutils literal notranslate"><span class="pre">estricto</span></code> realiza verificaciones
adicionales <strong>en tiempo de compilación</strong> sobre algunos errores comunes.</p>
<p>Este modo está habilitado con <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">strict</span></code> o cuando se ejecuta
Berry con la opción <code class="docutils literal notranslate"><span class="pre">-s</span></code>: <code class="docutils literal notranslate"><span class="pre">berry</span> <span class="pre">-s</span></code></p>
<section id="var-obligatorio-para-variables-locales">
<h3><code class="docutils literal notranslate"><span class="pre">var</span></code> obligatorio para variables locales<a class="headerlink" href="#var-obligatorio-para-variables-locales" title="Permalink to this headline">¶</a></h3>
<p>Este es el error más común, una variable asignada sin <code class="docutils literal notranslate"><span class="pre">var</span></code> es global
si ya existe una variable global o local en caso contrario. El modo
estricto rechaza la asignación si no hay un global con el mismo nombre.</p>
<p>No más permitido:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>def f()
  i = 0    # this is a local variable
  var j = 0
end
syntax_error: stdin:2: strict: no global &#39;i&#39;, ¿quiso decir &#39;var i&#39;?
</pre></div>
</div>
<p>Pero todavía funciona para globales:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">g_i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">()</span>
  <span class="n">g_i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">end</span>
</pre></div>
</div>
</section>
<section id="sin-anulacion-de-elementos-integrados">
<h3>Sin anulación de elementos integrados<a class="headerlink" href="#sin-anulacion-de-elementos-integrados" title="Permalink to this headline">¶</a></h3>
<p>Berry permite anular una función incorporada. Sin embargo, esto
generalmente no es deseable y es una fuente de errores difíciles de
encontrar.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">syntax_error</span><span class="p">:</span> <span class="n">stdin</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">estricto</span><span class="p">:</span> <span class="n">redefinición</span> <span class="n">de</span> <span class="s1">&#39;map&#39;</span> <span class="n">incorporado</span>
</pre></div>
</div>
</section>
<section id="multiples-var-con-el-mismo-nombre-no-permitidos-en-el-mismo-ambito">
<h3>Múltiples <code class="docutils literal notranslate"><span class="pre">var</span></code> con el mismo nombre no permitidos en el mismo ámbito<a class="headerlink" href="#multiples-var-con-el-mismo-nombre-no-permitidos-en-el-mismo-ambito" title="Permalink to this headline">¶</a></h3>
<p>Berry toleraba la declaración múltiple de una variable local con el
mismo nombre. Esto ahora se considera como un error (incluso sin modo
estricto).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">()</span>
  <span class="n">var</span> <span class="n">a</span>
  <span class="n">var</span> <span class="n">a</span>   <span class="c1"># redefinición de a</span>
<span class="n">end</span>
<span class="n">syntax_error</span><span class="p">:</span> <span class="n">stdin</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="n">redefinición</span> <span class="n">de</span> <span class="s1">&#39;a&#39;</span>
</pre></div>
</div>
</section>
<section id="no-ocultar-la-variable-local-del-alcance-externo">
<h3>No ocultar la variable local del alcance externo<a class="headerlink" href="#no-ocultar-la-variable-local-del-alcance-externo" title="Permalink to this headline">¶</a></h3>
<p>En Berry puedes declarar variables locales con el mismo nombre en el
ámbito interno. La variable en el ámbito interno oculta la variable del
ámbito externo durante la duración del ámbito.</p>
<p>La única excepción son las variables que comienzan con el punto ‘.’ que
se pueden enmascarar desde el alcance externo. Este es el caso de la
variable local oculta <code class="docutils literal notranslate"><span class="pre">.it</span></code> cuando se incrustan múltiples <code class="docutils literal notranslate"><span class="pre">for</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">()</span>
  <span class="n">var</span> <span class="n">a</span>    <span class="c1"># variable en el ámbito externo</span>
  <span class="k">if</span> <span class="n">a</span>
    <span class="n">var</span> <span class="n">a</span>  <span class="c1"># redefinición de a en ámbito interno</span>
  <span class="n">end</span>
<span class="n">end</span>
<span class="n">syntax_error</span><span class="p">:</span> <span class="n">stdin</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span> <span class="n">estricto</span><span class="p">:</span>  <span class="n">redefinición</span> <span class="n">de</span> <span class="s1">&#39;a&#39;</span> <span class="n">desde</span> <span class="n">el</span> <span class="n">ámbito</span> <span class="n">externo</span>
</pre></div>
</div>
</section>
</section>
<section id="miembros-virtuales">
<h2>8.2 Miembros virtuales<a class="headerlink" href="#miembros-virtuales" title="Permalink to this headline">¶</a></h2>
<p>Los miembros virtuales le permiten agregar de forma dinámica y
programática miembros y métodos a clases y módulos. Ya no está limitado
a los miembros declarados en el momento de la creación.</p>
<p>Esta función está inspirada en <code class="docutils literal notranslate"><span class="pre">__getattr__()</span></code> / <code class="docutils literal notranslate"><span class="pre">__setattr__()</span></code> de
Python. La motivación proviene de la integración de LVGL a Berry en
Tasmota. La integración necesita cientos de constantes en un módulo y
miles de métodos asignados a funciones C. La creación estática de
atributos y métodos funciona, pero consume una cantidad significativa de
espacio de código.</p>
<p>Esta característica permite crear dos métodos:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 93%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Mét
odo
Be
rry</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>`
<cite>me
mbe
r`</cite></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(nombre:cadena)</span> <span class="pre">-&gt;</span> <span class="pre">any</span></code> Debería devolver el valor del
<code class="docutils literal notranslate"><span class="pre">nombre</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>`
<cite>se
tme
mbe
r`</cite></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(nombre:cadena,</span> <span class="pre">valor:any)</span> <span class="pre">especificado</span> <span class="pre">-&gt;</span> <span class="pre">nil</span></code> Debería
almacenar el ‘valor’ en el miembro virtual con el ‘nombre’
especificado</p></td>
</tr>
</tbody>
</table>
<section id="modulo-undefined">
<h3>Módulo <code class="docutils literal notranslate"><span class="pre">undefined</span></code><a class="headerlink" href="#modulo-undefined" title="Permalink to this headline">¶</a></h3>
<p>La función <code class="docutils literal notranslate"><span class="pre">member()</span></code> debe ser capaz de distinguir entre un miembro
con un valor <code class="docutils literal notranslate"><span class="pre">nil</span></code> y el miembro que no existe. Para evitar cualquier
ambigüedad, la función <code class="docutils literal notranslate"><span class="pre">member()</span></code> puede indicar que el miembro no
existe de dos maneras:</p>
<ul class="simple">
<li><p>generar una excepción - o <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">undefined</span></code> y devolver el módulo
<code class="docutils literal notranslate"><span class="pre">undefined</span></code>. Esto se usa como un marcador para que la VM sepa que
el atributo no existe, mientras se beneficia de excepciones
consistentes.</p></li>
</ul>
<p>Ejemplo de un objeto dinámico al que puede agregar miembros, pero
devolvería un error si el miembro no se agregó previamente.</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">dyn</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">_attr</span><span class="w"></span>
<span class="w">    </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="na">_attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="ow">end</span><span class="w"></span>
<span class="w">    </span><span class="kd">def</span><span class="w"> </span><span class="nf">setmember</span><span class="p">(</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">valor</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kr">self</span><span class="p">.</span><span class="na">_attr</span><span class="p">[</span><span class="n">nombre</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valor</span><span class="w"></span>
<span class="w">    </span><span class="ow">end</span><span class="w"></span>
<span class="w">    </span><span class="kd">def</span><span class="w"> </span><span class="nf">member</span><span class="p">(</span><span class="n">nombre</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="ow">if</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="na">_attr</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">nombre</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="ow">return</span><span class="w"> </span><span class="kr">self</span><span class="p">.</span><span class="na">_attr</span><span class="p">[</span><span class="n">nombre</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="ow">else</span><span class="w"></span>
<span class="w">            </span><span class="kr">import</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">            </span><span class="ow">return</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">        </span><span class="ow">end</span><span class="w"></span>
<span class="w">    </span><span class="ow">end</span><span class="w"></span>
<span class="ow">end</span><span class="w"></span>
</pre></div>
</div>
<p>Ejemplo de uso:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span>&gt; a = dyn()
&gt; a.a
attribute_error: el objeto &#39;dyn&#39; no tiene el atributo &#39;a&#39;
stack traceback:
    stdin:1: en función `main`
&gt; a.a = 1
&gt; a.a
1
&gt; a.a = nil
&gt; a.a
&gt;
</pre></div>
</div>
</section>
<section id="llamada-implicita-de-member">
<h3>Llamada implícita de <code class="docutils literal notranslate"><span class="pre">member()</span></code><a class="headerlink" href="#llamada-implicita-de-member" title="Permalink to this headline">¶</a></h3>
<p>Cuando se ejecuta el siguiente código <code class="docutils literal notranslate"><span class="pre">a.b</span></code>, Berry VM hace lo
siguiente:</p>
<ul class="simple">
<li><p>Obtiene el objeto llamado <code class="docutils literal notranslate"><span class="pre">a</span></code> (local o global), genera una
excepción si no existe</p></li>
<li><p>Comprueba si el objeto <code class="docutils literal notranslate"><span class="pre">a</span></code> es de tipo <code class="docutils literal notranslate"><span class="pre">módulo</span></code>, <code class="docutils literal notranslate"><span class="pre">instancia</span></code> o
<code class="docutils literal notranslate"><span class="pre">clase</span></code>. Genera una excepción de lo contrario</p></li>
<li><p>Comprueba si el objeto <code class="docutils literal notranslate"><span class="pre">a</span></code> tiene un miembro llamado <code class="docutils literal notranslate"><span class="pre">b</span></code>. En caso
afirmativo, devuelve su valor, en caso negativo, procede a
continuación</p></li>
<li><p>Si el objeto <code class="docutils literal notranslate"><span class="pre">a</span></code> es del tipo <code class="docutils literal notranslate"><span class="pre">clase</span></code>, genera una excepción porque
los miembros virtuales no funcionan para métodos estáticos (clase)</p></li>
<li><p>Comprueba si el objeto <code class="docutils literal notranslate"><span class="pre">a</span></code> tiene un miembro llamado <code class="docutils literal notranslate"><span class="pre">member</span></code> y es
una <code class="docutils literal notranslate"><span class="pre">función</span></code>. En caso afirmativo, lo llama con el parámetro
<code class="docutils literal notranslate"><span class="pre">&quot;b&quot;</span></code> como cadena. Si no, genera una excepción</p></li>
<li><p>Comprueba el valor de retorno. Si es el módulo <code class="docutils literal notranslate"><span class="pre">undefined</span></code> genera
una excepción que indica que el miembro no existe</p></li>
</ul>
</section>
<section id="llamada-implicita-de-setmember">
<h3>Llamada implícita de <code class="docutils literal notranslate"><span class="pre">setmember()</span></code><a class="headerlink" href="#llamada-implicita-de-setmember" title="Permalink to this headline">¶</a></h3>
<p>Cuando se ejecuta el siguiente código <code class="docutils literal notranslate"><span class="pre">ab</span> <span class="pre">=</span> <span class="pre">0</span></code> (mutador), Berry VM
hace lo siguiente:</p>
<ul class="simple">
<li><p>Obtiene el objeto llamado <code class="docutils literal notranslate"><span class="pre">a</span></code> (local o global), genera una
excepción si no existe</p></li>
<li><p>Comprueba si el objeto <code class="docutils literal notranslate"><span class="pre">a</span></code> es de tipo <code class="docutils literal notranslate"><span class="pre">módulo</span></code>, <code class="docutils literal notranslate"><span class="pre">instancia</span></code> o
<code class="docutils literal notranslate"><span class="pre">clase</span></code>. Genera una excepción de lo contrario</p>
<ul>
<li><p>Si <code class="docutils literal notranslate"><span class="pre">a</span></code> es del tipo <code class="docutils literal notranslate"><span class="pre">clase</span></code>, comprueba si existe el miembro
<code class="docutils literal notranslate"><span class="pre">b</span></code>. En caso afirmativo, cambia su valor. Si no, genera una
excepción. (los miembros virtuales no funcionan para clases o
métodos estáticos)</p></li>
<li><p>Si <code class="docutils literal notranslate"><span class="pre">a</span></code> es del tipo <code class="docutils literal notranslate"><span class="pre">instancia</span></code>, comprueba si existe el miembro
<code class="docutils literal notranslate"><span class="pre">b</span></code>. En caso afirmativo, cambia su valor. Si no, procede a
continuación</p>
<ul>
<li><p>Comprueba si <code class="docutils literal notranslate"><span class="pre">a</span></code> tiene un miembro llamado <code class="docutils literal notranslate"><span class="pre">setmember</span></code>. Si
es así, lo llama, si no, genera una excepción.</p></li>
</ul>
</li>
<li><p>Si <code class="docutils literal notranslate"><span class="pre">a</span></code> es de tipo <code class="docutils literal notranslate"><span class="pre">módulo</span></code>. Si el módulo no es de solo
lectura, crea o cambia el valor (<code class="docutils literal notranslate"><span class="pre">setmember</span></code> nunca se llama para
un módulo de escritura). Si el módulo es de solo lectura, entonces
se llama a <code class="docutils literal notranslate"><span class="pre">setmember</span></code> si existe.</p></li>
</ul>
</li>
</ul>
</section>
<section id="manejo-de-excepciones">
<h3>Manejo de excepciones<a class="headerlink" href="#manejo-de-excepciones" title="Permalink to this headline">¶</a></h3>
<p>Para indicar que un miembro no existe, <code class="docutils literal notranslate"><span class="pre">member()</span></code> devolverá
<code class="docutils literal notranslate"><span class="pre">undefined</span></code> después de <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">undefined</span></code>. También puede generar una
excepción en <code class="docutils literal notranslate"><span class="pre">member()</span></code>, pero tenga en cuenta que Berry podría
intentar llamar a métodos como <code class="docutils literal notranslate"><span class="pre">tostring()</span></code> que aterrizarán en su
método <code class="docutils literal notranslate"><span class="pre">member()</span></code> si no existen como métodos estáticos. Para indicar
que un miembro no es válido, <code class="docutils literal notranslate"><span class="pre">setmember()</span></code> debe generar una excepción
o devolver <code class="docutils literal notranslate"><span class="pre">undefined</span></code>. Devolver cualquier otra cosa como <code class="docutils literal notranslate"><span class="pre">nil</span></code>
indica que la asignación fue exitosa. Tenga en cuenta que puede recibir
nombres de miembros que no sean identificadores válidos de Berry. La
sintaxis <code class="docutils literal notranslate"><span class="pre">a.(&quot;&lt;-&gt;&quot;)</span></code> llamará a <code class="docutils literal notranslate"><span class="pre">a.member(&quot;&lt;-&gt;&quot;)</span></code> con un nombre de
miembro virtual que no es léxicamente válido, es decir, no se puede
llamar en código normal, excepto mediante el uso indirecto formas como
<code class="docutils literal notranslate"><span class="pre">introspect</span></code> o <code class="docutils literal notranslate"><span class="pre">member()</span></code>.</p>
</section>
<section id="especificidades-para-las-clases">
<h3>Especificidades para las clases<a class="headerlink" href="#especificidades-para-las-clases" title="Permalink to this headline">¶</a></h3>
<p>El acceso a los miembros del objeto de clase no desencadena miembros
virtuales. Por lo tanto, no es posible tener métodos estáticos
virtuales.</p>
</section>
<section id="especificidades-de-los-modulos">
<h3>Especificidades de los módulos<a class="headerlink" href="#especificidades-de-los-modulos" title="Permalink to this headline">¶</a></h3>
<p>Los módulos admiten la lectura de miembros estáticos con <code class="docutils literal notranslate"><span class="pre">member()</span></code>.
Al escribir en un miembro, el comportamiento depende de si el módulo es
de escritura (en la memoria) o de solo lectura (en el firmware). Si se
puede escribir en el módulo, los nuevos miembros se agregan directamente
al módulo y nunca se llama a <code class="docutils literal notranslate"><span class="pre">setmember()</span></code>. Si el módulo es de solo
lectura, se llama a <code class="docutils literal notranslate"><span class="pre">setmember()</span></code> cada vez que intenta cambiar o crear
un miembro. Entonces es su responsabilidad almacenar los valores en un
objeto separado como un global.</p>
</section>
<section id="ejemplo">
<h3>Ejemplo<a class="headerlink" href="#ejemplo" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">T</span>
    <span class="n">var</span> <span class="n">a</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
    <span class="n">end</span>

    <span class="k">def</span> <span class="nf">member</span><span class="p">(</span><span class="n">nombre</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;miembro &quot;</span><span class="o">+</span><span class="n">nombre</span>
    <span class="n">end</span>

    <span class="k">def</span> <span class="nf">setmember</span><span class="p">(</span><span class="n">nombre</span><span class="p">,</span> <span class="n">valor</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Almacenar &#39;&quot;</span><span class="o">+</span><span class="n">nombre</span><span class="o">+</span><span class="s2">&quot;&#39;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">valor</span><span class="p">))</span>
    <span class="n">end</span>
<span class="n">end</span>
<span class="n">t</span><span class="o">=</span><span class="n">T</span><span class="p">()</span>
</pre></div>
</div>
<p>Ahora intentémoslo:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">a</span><span class="w"></span>
<span class="s1">&#39;a&#39;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">b</span><span class="w"></span>
<span class="s1">&#39;miembro b&#39;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">foo</span><span class="w"></span>
<span class="s1">&#39;miembro foo&#39;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">Almacenar</span><span class="w"> </span><span class="s1">&#39;bar&#39;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
</pre></div>
</div>
<p>Esto también funciona para los módulos:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">module</span><span class="p">()</span><span class="w"></span>
<span class="n">m</span><span class="p">.</span><span class="na">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">m</span><span class="p">.</span><span class="na">member</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="p">(</span><span class="n">nombre</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="ow">return</span><span class="w"> </span><span class="s2">&quot;miembro &quot;</span><span class="o">+</span><span class="n">nombre</span><span class="w"></span>
<span class="ow">end</span><span class="w"></span>
<span class="n">m</span><span class="p">.</span><span class="nf">setmember</span><span class="p">(</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">valor</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Almacenar &#39;&quot;</span><span class="o">+</span><span class="n">nombre</span><span class="o">+</span><span class="s2">&quot;&#39;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">valor</span><span class="p">))</span><span class="w"></span>
<span class="ow">end</span><span class="w"></span>
</pre></div>
</div>
<p>Intentemoslo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">a</span>
<span class="mi">1</span>
<span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">b</span>
<span class="s1">&#39;miembro b&#39;</span>
<span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c1"># la asignación es válida por lo que no se llama a `setmember()</span>
<span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">c</span>
<span class="mi">3</span>
</pre></div>
</div>
<p>Ejemplo más avanzado:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span>&gt; class A
    var i

    def member(n)
      if n == &#39;ii&#39; return self.i end
      return nil     # lo hacemos explícito aquí, pero esta línea es opcional
    end

    def setmember(n, v)
      if n == &#39;ii&#39; self.i = v end
    end
  end
&gt; a=A()

&gt; a.i      # devuelve nil
&gt; a.ii     # i llama implícitamente `a.member(&quot;ii&quot;)`
attribute_error: el objeto &#39;A&#39; no tiene atributo &#39;ii&#39;
stack traceback:
    stdin:1: en función `main`
# devuelve un excepción ya que el miembro es nulo (considerado inexistente)

&gt; a.ii = 42    # llama implícitamente `a.setmember(&quot;ii&quot;, 42)`
&gt; a.ii         # llama implícitamente `a.member(&quot;ii&quot;)` and returns `42`
42
&gt; a.i          #  la variable concreta también fue cambiada
42
</pre></div>
</div>
</section>
</section>
<section id="como-empaquetar-un-modulo">
<h2>8.3 Cómo empaquetar un módulo<a class="headerlink" href="#como-empaquetar-un-modulo" title="Permalink to this headline">¶</a></h2>
<p>Esta guía lo lleva a través de las diferentes opciones de empaquetado de
código para su reutilización utilizando la directiva de “import” de
Berry.</p>
<section id="comportamiento-de-import">
<h3>Comportamiento de <code class="docutils literal notranslate"><span class="pre">import</span></code><a class="headerlink" href="#comportamiento-de-import" title="Permalink to this headline">¶</a></h3>
<p>Cuando se utiliza <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">&lt;modulo&gt;</span> <span class="pre">[as</span> <span class="pre">&lt;nombre&gt;</span> <span class="pre">]</span></code>, suceden los
siguientes pasos:</p>
<ul class="simple">
<li><p>Hay una caché global de todos los módulos ya importados. Si
<code class="docutils literal notranslate"><span class="pre">&lt;modulo&gt;</span></code> ya fue importado, <code class="docutils literal notranslate"><span class="pre">import</span></code> devuelve el valor en caché
ya devuelto por la primera llamada a <code class="docutils literal notranslate"><span class="pre">import</span></code>. No se realizan otras
acciones.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span></code> busca un módulo de nombre <code class="docutils literal notranslate"><span class="pre">&lt;modulo&gt;</span></code> en el siguiente
orden:</p></li>
</ul>
<ol class="arabic simple">
<li><p>en módulos nativos incrustados en el firmware en tiempo de
compilación</p></li>
<li><p>en el sistema de archivos, comenzando con el directorio actual, luego
iterando en todos los directorios desde <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>: busque el
archivo <code class="docutils literal notranslate"><span class="pre">&lt;nombre&gt;</span></code>, entonces <code class="docutils literal notranslate"><span class="pre">&lt;nombre&gt;.bec</span></code> (código de bytes
compilado), luego <code class="docutils literal notranslate"><span class="pre">&lt;nombre&gt;.be</span></code>. Si <code class="docutils literal notranslate"><span class="pre">BE_USE_SHARED_LIB</span></code> está
habilitado, también busca bibliotecas compartidas como
<code class="docutils literal notranslate"><span class="pre">&lt;nombre&gt;.so</span> <span class="pre">que</span></code> o <code class="docutils literal notranslate"><span class="pre">&lt;nombre&gt;.dll</span></code> aunque esta opción
generalmente no está disponible en MCU.</p></li>
</ol>
<ul class="simple">
<li><p>Se ejecuta el código cargado. El código debe terminar con una
declaración <code class="docutils literal notranslate"><span class="pre">return</span></code>. El objeto devuelto se almacena en la memoria
caché global y se pone a disposición de la persona que llama (en el
ámbito local o global).</p></li>
<li><p>Si el objeto devuelto es un <code class="docutils literal notranslate"><span class="pre">módulo</span></code> y si el módulo posee un
miembro <code class="docutils literal notranslate"><span class="pre">init</span></code>, entonces se toma un paso adicional. La función
<code class="docutils literal notranslate"><span class="pre">&lt;modulo&gt;.init(m)</span></code> se llama pasando como argumento el propio objeto
del módulo. El valor devuelto por <code class="docutils literal notranslate"><span class="pre">init()</span></code> reemplaza el valor en el
caché global. Tenga en cuenta que <code class="docutils literal notranslate"><span class="pre">init()</span></code> se llama como máximo una
vez durante la primera <code class="docutils literal notranslate"><span class="pre">importación</span></code>.</p></li>
</ul>
<p>Nota: una función <code class="docutils literal notranslate"><span class="pre">init(m)</span></code> implícita siempre está presente en todos
los módulos, incluso si no se declaró ninguno. Esta función implícita no
tiene ningún efecto.</p>
</section>
<section id="empaquetado-de-un-modulo">
<h3>Empaquetado de un módulo<a class="headerlink" href="#empaquetado-de-un-modulo" title="Permalink to this headline">¶</a></h3>
<p>Aquí hay un ejemplo simple de un módulo:</p>
<p>Archivo <code class="docutils literal notranslate"><span class="pre">demo_modulo.be</span></code>:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="c1"># modulo simple</span>
<span class="c1"># use `import demo_modulo`</span>

<span class="n">demo_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">module</span><span class="p">(</span><span class="s2">&quot;demo_module&quot;</span><span class="p">)</span><span class="w"></span>

<span class="n">demo_modulo</span><span class="p">.</span><span class="na">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;bar&quot;</span><span class="w"></span>

<span class="n">demo_modulo</span><span class="p">.</span><span class="na">decir_hola</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hola Berry!&quot;</span><span class="p">)</span><span class="w"></span>
<span class="ow">end</span><span class="w"></span>

<span class="ow">return</span><span class="w"> </span><span class="n">demo_modulo</span><span class="w">      </span><span class="c1"># devuelve el módulo como salida de import</span>
</pre></div>
</div>
<p>Ejemplo de uso:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="kr">import</span><span class="w"> </span><span class="n">demo_modulo</span><span class="w"></span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">demo_modulo</span><span class="w"></span>
<span class="o">&lt;</span><span class="nb">module</span><span class="o">:</span><span class="w"> </span><span class="n">demo_modulo</span><span class="o">&gt;</span><span class="w"></span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">demo_module</span><span class="p">.</span><span class="nf">decir_hola</span><span class="p">()</span><span class="w"></span>
<span class="n">Hola</span><span class="w"> </span><span class="n">Berry</span><span class="o">!</span><span class="w"></span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">demo_modulo</span><span class="p">.</span><span class="na">foo</span><span class="w"></span>
<span class="s1">&#39;bar&#39;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">demo_modulo</span><span class="p">.</span><span class="na">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;baz&quot;</span><span class="w">   </span><span class="c1"># el módulo se puede escribir, aunque esto es muy desaconsejado</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">demo_modulo</span><span class="p">.</span><span class="na">foo</span><span class="w"></span>
<span class="s1">&#39;baz&#39;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="empaquetar-un-singleton-monada">
<h3>Empaquetar un singleton (mónada)<a class="headerlink" href="#empaquetar-un-singleton-monada" title="Permalink to this headline">¶</a></h3>
<p>El problema de usar módulos es que no tienen variables de instancia para
realizar un seguimiento de los datos. Están diseñados esencialmente para
bibliotecas sin estado.</p>
<p>A continuación, encontrará una forma elegante de empaquetar una clase
única devuelta como una “declaración de importación”.</p>
<p>Para ello, utilizamos diferentes trucos. Primero, declaramos la clase
para el singleton como una clase interna de una función, esto evita que
se contamine el espacio de nombres global con esta clase. Es decir, la
clase no será accesible por otro código.</p>
<p>En segundo lugar, declaramos una función <code class="docutils literal notranslate"><span class="pre">init()</span></code> del módulo que crea
la clase, crea la instancia y la devuelve.</p>
<p>Según este esquema, <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">&lt;modulo&gt;</span></code> en realidad devuelve una
instancia de una clase oculta.</p>
<p>Ejemplo de <code class="docutils literal notranslate"><span class="pre">demo_monad.be</span></code>:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="c1"># monada simple</span>
<span class="c1"># use `import demo_monad`</span>

<span class="n">demo_monad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">module</span><span class="p">(</span><span class="s2">&quot;demo_monad&quot;</span><span class="p">)</span><span class="w"></span>

<span class="c1">#  el módulo tiene un solo miembro `init()` y delega todo a la clase interna</span>
<span class="n">demo_monad</span><span class="p">.</span><span class="na">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># inncer class</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">my_monad</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">        </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="kr">self</span><span class="p">.</span><span class="na">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="ow">end</span><span class="w"></span>

<span class="w">        </span><span class="kd">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hola Berry!&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="ow">end</span><span class="w"></span>
<span class="w">    </span><span class="ow">end</span><span class="w"></span>

<span class="w">    </span><span class="c1"># rdevolver una sola instancia para esta clase</span>
<span class="w">    </span><span class="ow">return</span><span class="w"> </span><span class="nf">my_monad</span><span class="p">()</span><span class="w"></span>
<span class="ow">end</span><span class="w"></span>

<span class="ow">return</span><span class="w"> </span><span class="n">demo_monad</span><span class="w">      </span><span class="c1"># evuelve el módulo como la salida de importación, que eventualmente se reemplaza por el valor de retorno de &#39;init()&#39;</span>
</pre></div>
</div>
<p>Ejemplo:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span>&gt; import demo_monad
&gt; demo_monad
&lt;instance: my_monad()&gt;     # es una instancia no un modulo

&gt; demo_monad.say_hello()
Hola Berry!

&gt; demo_monad.i = 42        #  puedes usarlo como cualquier instancia
&gt; demo_monad.i
42

&gt; demo_monad.j = 0         # hay una fuerte verificación de miembros en comparación con los módulos
Attribute_error: la clase &#39;my_monad&#39; no puede asignarse al atributo &#39;j&#39;
stack traceback:
    stdin:1: en función `main`
</pre></div>
</div>
</section>
</section>
<section id="solidificacion">
<h2>8.4 Solidificación<a class="headerlink" href="#solidificacion" title="Permalink to this headline">¶</a></h2>
<p>La solidificación es el proceso de capturar estructuras y códigos Berry
compilados (clases, módulos, mapas, listas…) y almacenarlos en el
firmware. Reduce drásticamente el uso de la memoria, pero tiene algunas
limitaciones.</p>
<section id="modulo-solidify">
<h3>Módulo <code class="docutils literal notranslate"><span class="pre">solidify</span></code><a class="headerlink" href="#modulo-solidify" title="Permalink to this headline">¶</a></h3>
<p>La solidificación es manejada por el módulo <code class="docutils literal notranslate"><span class="pre">solidify</span></code>. Este módulo no
está compilado por defecto debido a su tamaño (~10kB). Debe compilar con
la directiva <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">BE_USE_SOLIDIFY_MODULE</span> <span class="pre">1</span></code>.</p>
<p>El módulo tiene un solo miembro <code class="docutils literal notranslate"><span class="pre">dump(x)</span></code> que toma un solo argumento
(el objeto a solidificar) y envía a <code class="docutils literal notranslate"><span class="pre">stdout</span></code> el código solidificado.</p>
<p>De forma predeterminada, solidify agrega todas las constantes de cadena
al grupo global. En su lugar, puede generar cadenas débiles (elegibles
para la poda por parte del enlazador) estableciendo el segundo argumento
en “verdadero”.</p>
<p>Por defecto, <code class="docutils literal notranslate"><span class="pre">solidify.dump</span></code> genera el código solidificado en la
salida estándar. Puede especificar un archivo como tercer argumento. El
archivo debe estar abierto en modo de escritura y no está cerrado para
que pueda concatenar varios objetos.</p>
<p><code class="docutils literal notranslate"><span class="pre">solidify.dump(object:any,</span> <span class="pre">[,</span> <span class="pre">strings_weak:bool,</span> <span class="pre">file_out:file])</span> <span class="pre">-&gt;</span> <span class="pre">nil</span></code></p>
</section>
<section id="solidificacion-de-funciones">
<h3>Solidificación de funciones<a class="headerlink" href="#solidificacion-de-funciones" title="Permalink to this headline">¶</a></h3>
<p>Puede solidificar una sola función.</p>
<p>Ejemplo:</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">f</span><span class="p">()</span><span class="w"> </span><span class="ow">return</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span><span class="w"> </span><span class="ow">end</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="kr">import</span><span class="w"> </span><span class="n">solidify</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">solidify</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/********************************************************************</span>
<span class="cm">** Solidified function: f</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_closure</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w">   </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">  </span><span class="n">be_nested_proto</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* nstack */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* argc */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* varg */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has upvals */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no upvals */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has sup protos */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no sub protos */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has constants */</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* constants */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K0   */</span><span class="w">  </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">hello</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_f</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_solidified</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">binstruction</span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* code */</span><span class="w"></span>
<span class="w">      </span><span class="mh">0x80060000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0000  RET    1   K0</span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>
</pre></div>
</div>
<p>Para compilar utilizando cadenas débiles (es decir, cadenas que el
enlazador puede eliminar si el objeto no está incluido en el ejecutable
de destino), use <code class="docutils literal notranslate"><span class="pre">solidify.dump(f,</span> <span class="pre">true)</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/********************************************************************</span>
<span class="cm">** Solidified function: f</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_closure</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w">   </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">  </span><span class="n">be_nested_proto</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* nstack */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* argc */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* varg */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has upvals */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no upvals */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has sup protos */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no sub protos */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has constants */</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* constants */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K0   */</span><span class="w">  </span><span class="n">be_nested_str_weak</span><span class="p">(</span><span class="n">hello</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="n">be_str_weak</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_solidified</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">binstruction</span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* code */</span><span class="w"></span>
<span class="w">      </span><span class="mh">0x80060000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0000  RET    1   K0</span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="solidificacion-de-clases">
<h3>Solidificación de clases<a class="headerlink" href="#solidificacion-de-clases" title="Permalink to this headline">¶</a></h3>
<p>Cuando solidifica una clase, incrusta todos los subelementos. También se
agrega un código auxiliar <code class="docutils literal notranslate"><span class="pre">C</span></code> para crear la clase y agregarla al
ámbito global.</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w">  </span><span class="kd">class</span> <span class="nc">demo</span><span class="w"></span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">      </span><span class="kr">static</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;bar&quot;</span><span class="w"></span>

<span class="w">      </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="kr">self</span><span class="p">.</span><span class="na">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="ow">end</span><span class="w"></span>

<span class="w">      </span><span class="kd">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello Berry!&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="ow">end</span><span class="w"></span>
<span class="w">  </span><span class="ow">end</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="kr">import</span><span class="w"> </span><span class="n">solidify</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">solidify</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">demo</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/********************************************************************</span>
<span class="cm">** Solidified function: init</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_closure</span><span class="p">(</span><span class="n">demo_init</span><span class="p">,</span><span class="w">   </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">  </span><span class="n">be_nested_proto</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* nstack */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* argc */</span><span class="w"></span>
<span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* varg */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has upvals */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no upvals */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has sup protos */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no sub protos */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has constants */</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* constants */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K0   */</span><span class="w">  </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K1   */</span><span class="w">  </span><span class="n">be_const_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_init</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_solidified</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">binstruction</span><span class="p">[</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* code */</span><span class="w"></span>
<span class="w">      </span><span class="mh">0x90020101</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0000  SETMBR R0  K0  K1</span>
<span class="w">      </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0001  RET    0</span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>

<span class="cm">/********************************************************************</span>
<span class="cm">** Solidified function: say_hello</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_closure</span><span class="p">(</span><span class="n">demo_say_hello</span><span class="p">,</span><span class="w">   </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">  </span><span class="n">be_nested_proto</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">3</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* nstack */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* argc */</span><span class="w"></span>
<span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* varg */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has upvals */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no upvals */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has sup protos */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no sub protos */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has constants */</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* constants */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K0   */</span><span class="w">  </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">Hello_X20Berry_X21</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_say_hello</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_solidified</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">binstruction</span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* code */</span><span class="w"></span>
<span class="w">      </span><span class="mh">0x60040001</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0000  GETGBL R1  G1</span>
<span class="w">      </span><span class="mh">0x58080000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0001  LDCONST    R2  K0</span>
<span class="w">      </span><span class="mh">0x7C040200</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0002  CALL   R1  1</span>
<span class="w">      </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0003  RET    0</span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>

<span class="cm">/********************************************************************</span>
<span class="cm">** Solidified class: demo</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_class</span><span class="p">(</span><span class="n">demo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">be_nested_map</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bmapnode</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bmapnode</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">say_hello</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_closure</span><span class="p">(</span><span class="n">demo_say_hello_closure</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">init</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_closure</span><span class="p">(</span><span class="n">demo_init_closure</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">})),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">bstring</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">be_const_str_demo</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">be_load_demo_class</span><span class="p">(</span><span class="n">bvm</span><span class="w"> </span><span class="o">*</span><span class="n">vm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">be_pushntvclass</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">be_class_demo</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">be_setglobal</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;demo&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">be_pop</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Las subclases también son compatibles.</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="kd">class</span> <span class="nc">demo_sub</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">demo</span><span class="w"></span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="n">j</span><span class="w"></span>

<span class="w">      </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="kr">super</span><span class="p">(</span><span class="kr">self</span><span class="p">).</span><span class="nf">init</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="kr">self</span><span class="p">.</span><span class="na">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="ow">end</span><span class="w"></span>
<span class="w">  </span><span class="ow">end</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">solidify</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">demo_sub</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/********************************************************************</span>
<span class="cm">** Solidified function: init</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_closure</span><span class="p">(</span><span class="n">demo_sub_init</span><span class="p">,</span><span class="w">   </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">  </span><span class="n">be_nested_proto</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">3</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* nstack */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* argc */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* varg */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has upvals */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no upvals */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has sup protos */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no sub protos */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has constants */</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* constants */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K0   */</span><span class="w">  </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">init</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K1   */</span><span class="w">  </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K2   */</span><span class="w">  </span><span class="n">be_const_int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_init</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_solidified</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">binstruction</span><span class="p">[</span><span class="w"> </span><span class="mi">7</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* code */</span><span class="w"></span>
<span class="w">      </span><span class="mh">0x60040003</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0000  GETGBL R1  G3</span>
<span class="w">      </span><span class="mh">0x5C080000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0001  MOVE   R2  R0</span>
<span class="w">      </span><span class="mh">0x7C040200</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0002  CALL   R1  1</span>
<span class="w">      </span><span class="mh">0x8C040300</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0003  GETMET R1  R1  K0</span>
<span class="w">      </span><span class="mh">0x7C040200</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0004  CALL   R1  1</span>
<span class="w">      </span><span class="mh">0x90020302</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0005  SETMBR R0  K1  K2</span>
<span class="w">      </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0006  RET    0</span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>

<span class="cm">/********************************************************************</span>
<span class="cm">** Solidified class: demo_sub</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">bclass</span><span class="w"> </span><span class="n">be_class_demo</span><span class="p">;</span><span class="w"></span>
<span class="n">be_local_class</span><span class="p">(</span><span class="n">demo_sub</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_class_demo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">be_nested_map</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bmapnode</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bmapnode</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">init</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_closure</span><span class="p">(</span><span class="n">demo_sub_init_closure</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">})),</span><span class="w"></span>
<span class="w">    </span><span class="n">be_str_literal</span><span class="p">(</span><span class="s">&quot;demo_sub&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">be_load_demo_sub_class</span><span class="p">(</span><span class="n">bvm</span><span class="w"> </span><span class="o">*</span><span class="n">vm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">be_pushntvclass</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">be_class_demo_sub</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">be_setglobal</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;demo_sub&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">be_pop</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="solidificacion-de-modulos">
<h3>Solidificación de módulos<a class="headerlink" href="#solidificacion-de-modulos" title="Permalink to this headline">¶</a></h3>
<p>Cuando solidifica un módulo, incrusta todos los subelementos. También
funciona con listas o mapas incrustados.</p>
<div class="highlight-berry notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">()</span><span class="w"> </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello Berry!&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">end</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">module</span><span class="p">(</span><span class="s2">&quot;demo_module&quot;</span><span class="p">)</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;foo&quot;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">say_hello</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="o">:</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">}</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="kr">import</span><span class="w"> </span><span class="n">solidify</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">solidify</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/********************************************************************</span>
<span class="cm">** Solidified function: say_hello</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_closure</span><span class="p">(</span><span class="n">demo_module_say_hello</span><span class="p">,</span><span class="w">   </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">  </span><span class="n">be_nested_proto</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* nstack */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* argc */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* varg */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has upvals */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no upvals */</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has sup protos */</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* no sub protos */</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* has constants */</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="cm">/* constants */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* K0   */</span><span class="w">  </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">Hello_X20Berry_X21</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_say_hello</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">be_const_str_solidified</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">binstruction</span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="cm">/* code */</span><span class="w"></span>
<span class="w">      </span><span class="mh">0x60000001</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0000  GETGBL R0  G1</span>
<span class="w">      </span><span class="mh">0x58040000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0001  LDCONST    R1  K0</span>
<span class="w">      </span><span class="mh">0x7C000200</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0002  CALL   R0  1</span>
<span class="w">      </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w">  </span><span class="c1">//  0003  RET    0</span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="cm">/*******************************************************************/</span><span class="w"></span>

<span class="cm">/********************************************************************</span>
<span class="cm">** Solidified module: demo_module</span>
<span class="cm">********************************************************************/</span><span class="w"></span>
<span class="n">be_local_module</span><span class="p">(</span><span class="n">demo_module</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;demo_module&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">be_nested_map</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bmapnode</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bmapnode</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_simple_instance</span><span class="p">(</span><span class="n">be_nested_simple_instance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be_class_list</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">be_const_list</span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w">     </span><span class="n">be_nested_list</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bvalue</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bvalue</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">be_const_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">be_const_int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}))</span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_simple_instance</span><span class="p">(</span><span class="n">be_nested_simple_instance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be_class_map</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">be_const_map</span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w">     </span><span class="n">be_nested_map</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bmapnode</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">bmapnode</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">}))</span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_const_closure</span><span class="p">(</span><span class="n">demo_module_say_hello_closure</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">be_const_key</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="n">be_nested_str</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">}))</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="n">BE_EXPORT_VARIABLE</span><span class="w"> </span><span class="nf">be_define_const_native_module</span><span class="p">(</span><span class="n">demo_module</span><span class="p">);</span><span class="w"></span>
<span class="cm">/********************************************************************/</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="limitaciones-de-la-solidificacion">
<h3>limitaciones de la solidificación<a class="headerlink" href="#limitaciones-de-la-solidificacion" title="Permalink to this headline">¶</a></h3>
<p>La solidificación funciona para muchos objetos: <code class="docutils literal notranslate"><span class="pre">clase</span></code>, <code class="docutils literal notranslate"><span class="pre">módulo</span></code>,
<code class="docutils literal notranslate"><span class="pre">funciones</span></code> y constantes incrustadas u objetos como <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">real</span></code>,
<code class="docutils literal notranslate"><span class="pre">string</span></code>, <code class="docutils literal notranslate"><span class="pre">list</span></code> y <code class="docutils literal notranslate"><span class="pre">map</span></code>.</p>
<p>Limitaciones:</p>
<ul class="simple">
<li><p>Los upvals no son compatibles. No puede solidificar un cierre que
captura upvals del alcance externo</p></li>
<li><p>La captura de variables globales requiere compilar con la opción
<code class="docutils literal notranslate"><span class="pre">-g</span></code> “globales con nombre” (habilitada de forma predeterminada en
Tasmota)</p></li>
<li><p>Las constantes de cadena están limitadas a 255 bytes, cadenas largas
(más de 255 caracteres no son compatibles, porque nadie nunca los
necesitó)</p></li>
<li><p>Los objetos solidificados son de solo lectura, esto tiene algunas
consecuencias en las clases. Puede solidificar una clase con sus
miembros estáticos cuando se crea, pero no puede solidificar una
función que crea una clase derivada de otra clase o con miembros
estáticos. La razón principal es que la configuración de la
superclase o la asignación de miembros estáticos se implementa
mediante el código mutante en la nueva clase, que no puede funcionar
en una clase no mutante de solo lectura.</p></li>
<li><p>El código solidificado puede depender del tamaño de “int” y “real” y
es posible que no se transfiera a través de MCU con tipos de
diferentes tamaños. Es posible que deba volver a solidificar para
cada objetivo.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Capitulo-7.html" class="btn btn-neutral float-left" title="7. Bibliotecas y Módulos" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Capitulo-9.html" class="btn btn-neutral float-right" title="9. FFI" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Guan Wenliang &amp; Stephan Hadinger.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>